<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>IPDRAPI: org::ipdr::DiscoveryHandler Class Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.2 -->
<div class="qindex"><a class="qindex" href="../../index.html">Main&nbsp;Page</a> | <a class="qindex" href="../../modules.html">Modules</a> | <a class="qindex" href="../../namespaces.html">Namespace List</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="../../dirs.html">Directories</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="../../globals.html">Globals</a></div>
<div class="nav">
<a class="el" href="../../db/d96/namespaceorg.html">org</a>::<a class="el" href="../../df/d76/namespaceorg_1_1ipdr.html">ipdr</a>::<a class="el" href="../../d1/dc9/classorg_1_1ipdr_1_1_discovery_handler.html">DiscoveryHandler</a></div>
<h1>org::ipdr::DiscoveryHandler Class Reference</h1><table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Public Member Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d1/dc9/classorg_1_1ipdr_1_1_discovery_handler.html#a0">DiscoveryHandler</a> (<a class="el" href="../../db/df5/interfaceorg_1_1ipdr_1_1api_1_1configuration_1_1_collector_config_i.html">CollectorConfigI</a> <a class="el" href="../../d1/dc9/classorg_1_1ipdr_1_1_discovery_handler.html#p1">collectorConfig</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">boolean&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d1/dc9/classorg_1_1ipdr_1_1_discovery_handler.html#a1">isCanExit</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d1/dc9/classorg_1_1ipdr_1_1_discovery_handler.html#a2">close</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d1/dc9/classorg_1_1ipdr_1_1_discovery_handler.html#a3">run</a> ()</td></tr>

<tr><td colspan="2"><br><h2>Static Public Member Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static synchronized ArrayList&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d1/dc9/classorg_1_1ipdr_1_1_discovery_handler.html#e0">getTcpProtocols</a> (Inet4Address remoteAddress, int remotePort, int discoveryTimeout)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">static synchronized ArrayList&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d1/dc9/classorg_1_1ipdr_1_1_discovery_handler.html#e1">queryAllProtocols</a> (Inet4Address localAddress, int bootTime, Inet4Address remoteAddress, int remotePort, int discoveryTimeout)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">static synchronized int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d1/dc9/classorg_1_1ipdr_1_1_discovery_handler.html#e2">queryProtocolVersionOnly</a> (Inet4Address localAddress, int bootTime, Inet4Address remoteAddress, int remotePort, int discoveryTimeout, int defaultVersion)</td></tr>

<tr><td colspan="2"><br><h2>Static Public Attributes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static final int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d1/dc9/classorg_1_1ipdr_1_1_discovery_handler.html#s0">PROTOCOL_VERSION_UNKNOWN</a> = -1</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">static final int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d1/dc9/classorg_1_1ipdr_1_1_discovery_handler.html#s1">PROTOCOL_VERSION_UNSUPPORTED</a> = -2</td></tr>

<tr><td colspan="2"><br><h2>Protected Member Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d1/dc9/classorg_1_1ipdr_1_1_discovery_handler.html#b0">setCanExit</a> (boolean <a class="el" href="../../d1/dc9/classorg_1_1ipdr_1_1_discovery_handler.html#p0">canExit</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d1/dc9/classorg_1_1ipdr_1_1_discovery_handler.html#b1">handleUDPDatagram</a> (DatagramPacket packet)  throws ProtocolMalformedMsgException, IOException     </td></tr>

<tr><td colspan="2"><br><h2>Protected Attributes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">volatile boolean&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d1/dc9/classorg_1_1ipdr_1_1_discovery_handler.html#p0">canExit</a> = false</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="../../db/df5/interfaceorg_1_1ipdr_1_1api_1_1configuration_1_1_collector_config_i.html">CollectorConfigI</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d1/dc9/classorg_1_1ipdr_1_1_discovery_handler.html#p1">collectorConfig</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">DatagramSocket&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d1/dc9/classorg_1_1ipdr_1_1_discovery_handler.html#p2">socket</a> = null</td></tr>

</table>
<hr><a name="_details"></a><h2>Detailed Description</h2>
Handles incoming discovery requests. 
<p>
<hr><h2>Constructor &amp; Destructor Documentation</h2>
<a class="anchor" name="a0" doxytag="org::ipdr::DiscoveryHandler::DiscoveryHandler"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">org::ipdr::DiscoveryHandler::DiscoveryHandler           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../db/df5/interfaceorg_1_1ipdr_1_1api_1_1configuration_1_1_collector_config_i.html">CollectorConfigI</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>collectorConfig</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [inline]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Initializes the handler with given collector configuration<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>collectorConfig</em>&nbsp;</td><td></td></tr>
  </table>
</dl>
<div class="fragment"><pre class="fragment">00048     {
00049         <span class="keyword">this</span>.collectorConfig = <a class="code" href="../../d1/dc9/classorg_1_1ipdr_1_1_discovery_handler.html#p1">collectorConfig</a>;
00050     }
</pre></div>
<p>
    </td>
  </tr>
</table>
<hr><h2>Member Function Documentation</h2>
<a class="anchor" name="a2" doxytag="org::ipdr::DiscoveryHandler::close"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void org::ipdr::DiscoveryHandler::close           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [inline]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Shuts the discovery handler down <div class="fragment"><pre class="fragment">00075     {
00076         <a class="code" href="../../d1/dc9/classorg_1_1ipdr_1_1_discovery_handler.html#b0">setCanExit</a>(<span class="keyword">true</span>);
00077     }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="e0" doxytag="org::ipdr::DiscoveryHandler::getTcpProtocols"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">static synchronized ArrayList org::ipdr::DiscoveryHandler::getTcpProtocols           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Inet4Address&nbsp;</td>
          <td class="mdname" nowrap> <em>remoteAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>remotePort</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>discoveryTimeout</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"><code> [inline, static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Filters the TCP protocols from the result of a UDPDiscovery query <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>remoteAddress</em>&nbsp;</td><td>- exporter's IP </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>remotePort</em>&nbsp;</td><td>- UDP port </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>discoveryTimeout</em>&nbsp;</td><td>- UDP discovery timeout </td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>ArrayList </dd></dl>
<div class="fragment"><pre class="fragment">00144     {
00145         ArrayList allProtocols;
00146         <span class="keywordflow">try</span>
00147         {
00148             allProtocols = <a class="code" href="../../d1/dc9/classorg_1_1ipdr_1_1_discovery_handler.html#a0">DiscoveryHandler</a>.queryAllProtocols((Inet4Address) InetAddress.getLocalHost(), 0, remoteAddress, remotePort, discoveryTimeout);
00149             <span class="keywordflow">if</span> (allProtocols == null)
00150                 <span class="keywordflow">return</span> null;
00151             
00152             ArrayList result = <span class="keyword">new</span> ArrayList();
00153             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; allProtocols.size(); i++)
00154             {
00155                 ProtocolInfo info = (ProtocolInfo) allProtocols.get(i);
00156                 <span class="keywordflow">if</span> (info.getTransportType() == ProtocolInfo.TCP_TRANSPORT)
00157                     result.add(info);
00158             }
00159             <span class="keywordflow">return</span> result;
00160         }
00161         <span class="keywordflow">catch</span> (UnknownHostException e1)
00162         {
00163         }
00164         <span class="keywordflow">return</span> null;
00165         
00166     }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="b1" doxytag="org::ipdr::DiscoveryHandler::handleUDPDatagram"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void org::ipdr::DiscoveryHandler::handleUDPDatagram           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">DatagramPacket&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>packet</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>  throws <a class="el" href="../../d4/d86/classorg_1_1ipdr_1_1protocol_1_1_protocol_malformed_msg_exception.html">ProtocolMalformedMsgException</a>, IOException     <code> [inline, protected]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Encapsulates handling of an incoming VERSION_REQUEST. The method replies with VERSION_RESPONSE message, offering IPDR and CRANE protocols over TCP as available options, IPDR the default.<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>packet</em>&nbsp;</td><td>The incoming datagram </td></tr>
  </table>
</dl>
<dl compact><dt><b>Exceptions:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>ProtocolMalformedMsgException</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em>IOException</em>&nbsp;</td><td></td></tr>
  </table>
</dl>
<div class="fragment"><pre class="fragment">00270     {
00271         <span class="keywordflow">try</span>
00272         {
00273             ProtocolMsgVERSION_REQUEST message = <span class="keyword">new</span> ProtocolMsgVERSION_REQUEST(
00274                     packet.getData());
00275 
00276             ProtocolInfo defaultProtocol = <span class="keyword">new</span> ProtocolInfo(
00277                     ProtocolInfo.TCP_TRANSPORT, ProtocolInfo.IPDR_VERSION,
00278                     (<span class="keywordtype">short</span>) <a class="code" href="../../d1/dc9/classorg_1_1ipdr_1_1_discovery_handler.html#p1">collectorConfig</a>.getLocalPort(), (short) 0);
00279             ProtocolInfo extraProtocol = <span class="keyword">new</span> ProtocolInfo(
00280                     ProtocolInfo.TCP_TRANSPORT, ProtocolInfo.CRANE_VERSION,
00281                     (<span class="keywordtype">short</span>) <a class="code" href="../../d1/dc9/classorg_1_1ipdr_1_1_discovery_handler.html#p1">collectorConfig</a>.getLocalPort(), (short) 0);
00282             ArrayList extra = <span class="keyword">new</span> ArrayList();
00283             extra.add(extraProtocol);
00284 
00285             ProtocolMsgVERSION_RESPONSE response = <span class="keyword">new</span> ProtocolMsgVERSION_RESPONSE(
00286                     defaultProtocol, extra);
00287             byte[] responseRaw = response.createRawMsg();
00288             DatagramPacket outboundPacket = <span class="keyword">new</span> DatagramPacket(responseRaw,
00289                     responseRaw.length, message.getRequesterAddress(),
00290                     packet.getPort());
00291             <a class="code" href="../../d1/dc9/classorg_1_1ipdr_1_1_discovery_handler.html#p2">socket</a>.send(outboundPacket);
00292         }
00293         <span class="keywordflow">catch</span> (UnknownHostException e)
00294         {
00295             <span class="keywordflow">throw</span> <span class="keyword">new</span> ProtocolMalformedMsgException(<span class="stringliteral">"Bad requester address"</span>,
00296                     packet.getData(), ProtocolMsgVERSION_REQUEST.MSG_LENGTH, 0);
00297         }
00298     }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="org::ipdr::DiscoveryHandler::isCanExit"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">boolean org::ipdr::DiscoveryHandler::isCanExit           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [inline]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<dl compact><dt><b>Returns:</b></dt><dd>Returns the canExit. </dd></dl>
<div class="fragment"><pre class="fragment">00056     {
00057         <span class="keywordflow">return</span> <a class="code" href="../../d1/dc9/classorg_1_1ipdr_1_1_discovery_handler.html#p0">canExit</a>;
00058     }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="e1" doxytag="org::ipdr::DiscoveryHandler::queryAllProtocols"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">static synchronized ArrayList org::ipdr::DiscoveryHandler::queryAllProtocols           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Inet4Address&nbsp;</td>
          <td class="mdname" nowrap> <em>localAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>bootTime</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>Inet4Address&nbsp;</td>
          <td class="mdname" nowrap> <em>remoteAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>remotePort</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>discoveryTimeout</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"><code> [inline, static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Query for all protocols used by this connection <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>localAddress</em>&nbsp;</td><td>- collector's IP address </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>bootTime</em>&nbsp;</td><td>- requester boot time </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>remoteAddress</em>&nbsp;</td><td>- exporter's IP address </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>remotePort</em>&nbsp;</td><td>- exporter's port </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>discoveryTimeout</em>&nbsp;</td><td>- UDP discovery timeout </td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>ArrayList </dd></dl>
<div class="fragment"><pre class="fragment">00178     {
00179     <span class="keywordflow">try</span>
00180     {
00181         ProtocolMsgVERSION_REQUEST reqMessage = <span class="keyword">new</span> ProtocolMsgVERSION_REQUEST( localAddress, bootTime);
00182         DatagramSocket discoverySocket;
00183         discoverySocket = <span class="keyword">new</span> DatagramSocket();
00184         byte[] reqRawMessage = reqMessage.createRawMsg();
00185         DatagramPacket reqPacket = <span class="keyword">new</span> DatagramPacket(reqRawMessage, reqRawMessage.length, remoteAddress, remotePort);
00186         discoverySocket.send(reqPacket);
00187     
00188         byte [] buffer = <span class="keyword">new</span> byte[32000];
00189         DatagramPacket replyPacket = <span class="keyword">new</span> DatagramPacket(buffer, 32000);
00190         discoverySocket.setSoTimeout(discoveryTimeout);
00191         discoverySocket.receive(replyPacket);
00192 
00193         <span class="comment">// parse the packet</span>
00194         ProtocolMsgVERSION_RESPONSE response = <span class="keyword">new</span> ProtocolMsgVERSION_RESPONSE(replyPacket.getData());
00195         ArrayList result = <span class="keyword">new</span> ArrayList();
00196         result.add(response.getDefaultProtocol());
00197         result.addAll(response.getAdditionalProtocols());
00198         
00199         <span class="keywordflow">return</span> result;
00200     }
00201     <span class="keywordflow">catch</span>(SocketTimeoutException e)
00202     {
00203         <span class="keywordflow">return</span> null;
00204     }
00205     <span class="keywordflow">catch</span> (SocketException e)
00206     {
00207         LogManager.error(<span class="stringliteral">"DiscoveryHandler"</span>, <span class="stringliteral">"queryProtocolVersion"</span>, e.toString());
00208         <span class="keywordflow">return</span> null;
00209     }
00210     <span class="keywordflow">catch</span> (IOException e)
00211     {
00212         LogManager.error(<span class="stringliteral">"DiscoveryHandler"</span>, <span class="stringliteral">"queryProtocolVersion"</span>, e.toString());
00213         <span class="keywordflow">return</span> null;
00214     }
00215     <span class="keywordflow">catch</span> (ProtocolMalformedMsgException e)
00216     {
00217         LogManager.error(<span class="stringliteral">"DiscoveryHandler"</span>, <span class="stringliteral">"queryProtocolVersion"</span>, e.toString());
00218         <span class="keywordflow">return</span> null;
00219     }   
00220     }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="e2" doxytag="org::ipdr::DiscoveryHandler::queryProtocolVersionOnly"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">static synchronized int org::ipdr::DiscoveryHandler::queryProtocolVersionOnly           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Inet4Address&nbsp;</td>
          <td class="mdname" nowrap> <em>localAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>bootTime</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>Inet4Address&nbsp;</td>
          <td class="mdname" nowrap> <em>remoteAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>remotePort</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>discoveryTimeout</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>defaultVersion</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"><code> [inline, static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Return most latest version of IPDR type protocol which uses a TCP protocol <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>localAddress</em>&nbsp;</td><td>- collector IP address </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>bootTime</em>&nbsp;</td><td>- requester boot time </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>remoteAddress</em>&nbsp;</td><td>- exporter's IP address </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>remotePort</em>&nbsp;</td><td>- exporter's port </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>discoveryTimeout</em>&nbsp;</td><td>- UDP discovery time out </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>defaultVersion</em>&nbsp;</td><td>- defualt protocol version to query for </td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>int </dd></dl>
<div class="fragment"><pre class="fragment">00233     {
00234             ArrayList protos = <a class="code" href="../../d1/dc9/classorg_1_1ipdr_1_1_discovery_handler.html#e1">queryAllProtocols</a>(localAddress, bootTime, remoteAddress, remotePort, discoveryTimeout );
00235             <span class="keywordflow">if</span> (protos == null)
00236                 <span class="keywordflow">return</span> <a class="code" href="../../d1/dc9/classorg_1_1ipdr_1_1_discovery_handler.html#s1">PROTOCOL_VERSION_UNSUPPORTED</a>;
00237             <span class="comment">// check the default proto:</span>
00238             ProtocolInfo defaultProtocol = (ProtocolInfo)protos.get(0);
00239             <span class="comment">// if it is TCP, accept it.</span>
00240             <span class="keywordflow">if</span> (defaultProtocol.getTransportType() == ProtocolInfo.TCP_TRANSPORT)
00241                 <span class="keywordflow">return</span> defaultProtocol.getProtocolVersion();
00242             
00243             <span class="keywordtype">int</span> supportedAlternative = <a class="code" href="../../d1/dc9/classorg_1_1ipdr_1_1_discovery_handler.html#s1">PROTOCOL_VERSION_UNSUPPORTED</a>;
00244             <span class="comment">// locate tcp transport and default version</span>
00245             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 1 ; i &lt; protos.size(); i ++)
00246             {
00247                 ProtocolInfo proto = (ProtocolInfo)protos.get(i);
00248                 <span class="keywordflow">if</span> (proto.getTransportType() != ProtocolInfo.TCP_TRANSPORT)
00249                     <span class="keywordflow">continue</span>;
00250                 <span class="keywordflow">if</span> (proto.getProtocolVersion() == defaultVersion )
00251                     <span class="keywordflow">return</span> defaultVersion;
00252                 <span class="keywordflow">if</span> (proto.getProtocolVersion() == ProtocolInfo.IPDR_VERSION || proto.getProtocolVersion() == ProtocolInfo.CRANE_VERSION)
00253                     supportedAlternative =proto.getProtocolVersion(); 
00254             }
00255             <span class="keywordflow">return</span> supportedAlternative;
00256 
00257    }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="org::ipdr::DiscoveryHandler::run"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void org::ipdr::DiscoveryHandler::run           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [inline]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<dl compact><dt><b>See also:</b></dt><dd>java.lang.Runnable#run() </dd></dl>
<div class="fragment"><pre class="fragment">00083     {
00084         setName(<span class="stringliteral">"Discovery handler"</span>);
00085         <span class="keywordflow">try</span>
00086         {
00087             <a class="code" href="../../d1/dc9/classorg_1_1ipdr_1_1_discovery_handler.html#p2">socket</a> = <span class="keyword">new</span> DatagramSocket(<a class="code" href="../../d1/dc9/classorg_1_1ipdr_1_1_discovery_handler.html#p1">collectorConfig</a>.getUDPDiscoveryPort(),
00088                     <a class="code" href="../../d1/dc9/classorg_1_1ipdr_1_1_discovery_handler.html#p1">collectorConfig</a>.getCollectorAddress());
00089             LogManager.info(<span class="keyword">this</span>, <span class="stringliteral">"run"</span>, <span class="stringliteral">"Listening for incoming UDP requests on "</span> + <a class="code" href="../../d1/dc9/classorg_1_1ipdr_1_1_discovery_handler.html#p1">collectorConfig</a>.getUDPDiscoveryPort());
00090             <a class="code" href="../../d1/dc9/classorg_1_1ipdr_1_1_discovery_handler.html#p2">socket</a>.setSoTimeout(<a class="code" href="../../d1/dc9/classorg_1_1ipdr_1_1_discovery_handler.html#p1">collectorConfig</a>.getAcceptTimeout());
00091             byte[] buffer = <span class="keyword">new</span> byte[ProtocolMsgVERSION_REQUEST.MSG_LENGTH];
00092 
00093             DatagramPacket packet = <span class="keyword">new</span> DatagramPacket(buffer,
00094                     ProtocolMsgVERSION_REQUEST.MSG_LENGTH);
00095 
00096             <span class="keywordflow">while</span> (!<a class="code" href="../../d1/dc9/classorg_1_1ipdr_1_1_discovery_handler.html#a1">isCanExit</a>())
00097             {
00098                 <span class="keywordflow">try</span>
00099                 {
00100                     <a class="code" href="../../d1/dc9/classorg_1_1ipdr_1_1_discovery_handler.html#p2">socket</a>.receive(packet);
00101                     <span class="comment">// packet arrived. handle it.</span>
00102                     <a class="code" href="../../d1/dc9/classorg_1_1ipdr_1_1_discovery_handler.html#b1">handleUDPDatagram</a>(packet);
00103                 }
00104                 <span class="keywordflow">catch</span> (SocketTimeoutException e)
00105                 {
00106                 }
00107                 <span class="keywordflow">catch</span> (ProtocolMalformedMsgException e)
00108                 {
00109                     LogManager.error(<span class="keyword">this</span>, <span class="stringliteral">"run"</span>, e.getMessage());
00110                 }
00111                 <span class="keywordflow">catch</span> (IOException e)
00112                 {
00113                     LogManager.error(<span class="keyword">this</span>, <span class="stringliteral">"run"</span>, e.getMessage());
00114                 }
00115             }
00116         }
00117         <span class="keywordflow">catch</span> (SocketException e)
00118         {
00119             LogManager.error(<span class="keyword">this</span>, <span class="stringliteral">"run"</span>, e.getMessage());
00120         }
00121         finally
00122         {
00123             <span class="keywordflow">try</span>
00124             {
00125                 <a class="code" href="../../d1/dc9/classorg_1_1ipdr_1_1_discovery_handler.html#p2">socket</a>.close();
00126             }
00127             <span class="keywordflow">catch</span> (Exception e)
00128             {
00129             }
00130         }
00131     }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="b0" doxytag="org::ipdr::DiscoveryHandler::setCanExit"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void org::ipdr::DiscoveryHandler::setCanExit           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">boolean&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>canExit</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [inline, protected]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Sets canExit when it is time to quit.<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>canExit</em>&nbsp;</td><td>The canExit to set. </td></tr>
  </table>
</dl>
<div class="fragment"><pre class="fragment">00067     {
00068         <span class="keyword">this</span>.canExit = <a class="code" href="../../d1/dc9/classorg_1_1ipdr_1_1_discovery_handler.html#p0">canExit</a>;
00069     }
</pre></div>
<p>
    </td>
  </tr>
</table>
<hr><h2>Field Documentation</h2>
<a class="anchor" name="p0" doxytag="org::ipdr::DiscoveryHandler::canExit"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">volatile boolean <a class="el" href="../../d1/dc9/classorg_1_1ipdr_1_1_discovery_handler.html#p0">org::ipdr::DiscoveryHandler::canExit</a> = false<code> [protected]</code>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Indicates that the thread may exit     </td>
  </tr>
</table>
<a class="anchor" name="p1" doxytag="org::ipdr::DiscoveryHandler::collectorConfig"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"><a class="el" href="../../db/df5/interfaceorg_1_1ipdr_1_1api_1_1configuration_1_1_collector_config_i.html">CollectorConfigI</a> <a class="el" href="../../d1/dc9/classorg_1_1ipdr_1_1_discovery_handler.html#p1">org::ipdr::DiscoveryHandler::collectorConfig</a><code> [protected]</code>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Holds collector configuration     </td>
  </tr>
</table>
<a class="anchor" name="s0" doxytag="org::ipdr::DiscoveryHandler::PROTOCOL_VERSION_UNKNOWN"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">final int <a class="el" href="../../d1/dc9/classorg_1_1ipdr_1_1_discovery_handler.html#s0">org::ipdr::DiscoveryHandler::PROTOCOL_VERSION_UNKNOWN</a> = -1<code> [static]</code>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="s1" doxytag="org::ipdr::DiscoveryHandler::PROTOCOL_VERSION_UNSUPPORTED"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">final int <a class="el" href="../../d1/dc9/classorg_1_1ipdr_1_1_discovery_handler.html#s1">org::ipdr::DiscoveryHandler::PROTOCOL_VERSION_UNSUPPORTED</a> = -2<code> [static]</code>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="p2" doxytag="org::ipdr::DiscoveryHandler::socket"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">DatagramSocket <a class="el" href="../../d1/dc9/classorg_1_1ipdr_1_1_discovery_handler.html#p2">org::ipdr::DiscoveryHandler::socket</a> = null<code> [protected]</code>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Holds datagram listening socket     </td>
  </tr>
</table>
<hr>The documentation for this class was generated from the following file:<ul>
<li>ipdr/Collector/org/ipdr/<a class="el" href="../../dd/d1d/_discovery_handler_8java.html">DiscoveryHandler.java</a></ul>
<hr size="1"><address style="align: right;"><small>Generated on Mon Apr 25 09:26:52 2005 for IPDRAPI by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.2 </small></address>
</body>
</html>
